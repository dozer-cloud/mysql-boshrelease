#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
source /var/vcap/jobs/mysql/helpers/ctl_setup.sh 'mysql'

export PORT=${PORT:-5000}
export LANG=en_US.UTF-8

PIDFILE=$RUN_DIR/mysqld.pid
CONF_DIR=/var/vcap/jobs/mysql/config
MY_LD_FILE=/etc/ld.so.conf.d/mysql.conf

SERVER=/var/vcap/packages/mysql/libexec/mysql.server

case $1 in

  start)
    # set the system wide LD path for mysql libraries
    echo "/var/vcap/packages/mysqlclient/lib/mysql" > $MY_LD_FILE
    echo "/var/vcap/packages/mysql/lib/mysql" >> $MY_LD_FILE
    /sbin/ldconfig

    $SERVER start $CONF_DIR/my.cnf
    ;;

  stop)
    $SERVER stop $CONF_DIR/my.cnf

    ;;
  *)
    echo "Usage: mysql_ctl {start|stop}"

    ;;

esac
exit 0